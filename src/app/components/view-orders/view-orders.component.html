<div class="container mt-4">
    <h1 class="mb-4" *ngIf="!hideDatePicker">Order Details</h1>
    
    <!-- Search and Filter Controls - Only show if not hidden -->
    <div class="row justify-content-center mb-4" *ngIf="!hideDatePicker">
        <div class="col-md-2 mb-2">
            <select class="form-select rounded-pill px-3" [(ngModel)]="searchType">
              <option value="" disabled selected hidden>Search type</option>
              <option value="id">Search by Order ID</option>
              <option value="date">Search by Date</option>
            </select>
          </div>
          
        <div class="col-md-4 position-relative">
          <input
            [type]="searchType === 'date' ? 'date' : 'text'"
            class="form-control rounded-pill px-4 pe-5"
            [placeholder]="searchType === 'id' ? 'üîç Search by ID...' : searchType === 'date' ? 'üìÖ Search by date...' : 'Search here..'"
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
          />
          
          <button
            class="btn btn-sm btn-link text-danger position-absolute top-50 end-0 translate-middle-y me-3"
            (click)="clearSearch()"
            style="text-decoration: none;"
          >
            ‚úñ
          </button>
        </div>

        <div class="col-md-2 mb-2">
          <select class="form-select rounded-pill px-3" [(ngModel)]="orderStatusFilter" (change)="onStatusFilterChange()">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="Pending">Pending</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      
      
      
  <!-- Orders Table Container with Scroll -->
  <div class="orders-table-container">
    <table class="table table-striped">
      <thead class="table-dark sticky-header">
        <tr>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">Order ID</th>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">Status</th>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">Ordered time</th>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">TotalAmount</th>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">PaymentMethod</th>
          <th style="text-align: left !important; background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--secondary-color, #0056b3) 100%); color: white;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let cart of filteredCarts">
          <tr>
            <td>{{ cart.orderId }}</td>
            <td>
              <span class="badge" [class]="getStatusBadgeClass(cart)">
                {{ getStatusText(cart) }}
              </span>
            </td>
            <td>{{ cart.createdAt | date:'short'}}</td>
            <td>{{currency}}{{ cart.totalAmount }}</td>
            <td>{{ cart.paymentMethod }}</td>
            <td>
              <!-- Draft Actions - All buttons in same row with space -->
              <div *ngIf="isDraftOrder(cart)" class="d-flex align-items-center gap-2">
                <button 
                  class="btn btn-success btn-sm" 
                  (click)="restoreDraftToCart(cart)"
                  title="Restore to Cart"
                >
                  üõí
                </button>
                <button 
                  class="btn btn-primary btn-sm" 
                  (click)="completeDraftOrder(cart)"
                  title="Complete Order"
                >
                  ‚úÖ
                </button>
                <button 
                  class="btn btn-danger btn-sm" 
                  (click)="deleteOrder(cart)"
                  title="Delete Order"
                >
                  üóëÔ∏è
                </button>
                <button mat-icon-button (click)="cart.expanded = !cart.expanded" class="expand-btn">
                  <i class="fas {{ cart.expanded ? 'fa-chevron-up' : 'fa-chevron-down' }}" style="color: white !important;"></i>
                </button>
              </div>
              
              <!-- Regular Order Actions - DELETE button and ARROW button in same row with space -->
              <div *ngIf="!isDraftOrder(cart)" class="d-flex align-items-center gap-2">
                <button 
                  class="btn btn-danger btn-sm" 
                  (click)="deleteOrder(cart)"
                  title="Delete Order"
                >
                  üóëÔ∏è
                </button>
                <button mat-icon-button (click)="cart.expanded = !cart.expanded" class="expand-btn">
                  <i class="fas {{ cart.expanded ? 'fa-chevron-up' : 'fa-chevron-down' }}" style="color: white !important;"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="cart.expanded">
            <td colspan="7">
              <mat-expansion-panel [expanded]="true">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Order Items
                  </mat-panel-title>
                </mat-expansion-panel-header>
  
                <div class="order-items-container">
                  <table class="table table-sm table-striped">
                    <thead class="table-secondary sticky-sub-header">
                      <tr>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;">Product ID</th>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;">Item</th>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;">Quantity</th>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;">Price</th>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;">Total</th>
                        <th style="text-align: left !important; background-color: var(--secondary-color); color: white;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of cart.orderItems">
                        <td>{{ item.productId || item.product.id }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.product.isPartialAllowed && item.size ? item.size : item.quantity }} {{item.product.isPartialAllowed ? (item.product.unit) : ''}}</td>
                        <td>{{currency}}{{ item.price }}</td>
                        <td>{{currency}}{{ item.total}}</td>
                        <td class="text-center">
                          <button 
                            class="btn btn-outline-primary btn-sm rounded-pill px-3 custom-btn-style" (click)="viewProduct(item)">
                            View
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </mat-expansion-panel>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="filteredCarts.length > 0" class="pagination-container">
    <app-pagination
      [totalCount]="totalCount"
      [pageNumber]="filter.pageNumber"
      [pageSize]="filter.pageSize"
      (pageChange)="onPageChange($event)">
    </app-pagination>
  </div>

  <!-- Filter info -->
  <div *ngIf="filteredCarts.length > 0" class="text-center mt-2">
    <small class="text-muted">
      Showing {{ filteredCarts.length }} of {{ carts.length }} orders
      <span *ngIf="searchQuery || orderStatusFilter" class="text-primary">
        (filtered)
      </span>
    </small>
  </div>
  